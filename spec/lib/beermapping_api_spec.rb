require 'rails_helper'

describe "BeermappingApi" do
  it "When HTTP GET returns one entry, it is parsed and returned" do

    canned_answer = <<-END_OF_STRING
<?xml version='1.0' encoding='utf-8' ?><bmp_locations><location><id>12411</id><name>Gallows Bird</name><status>Brewery</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=12411</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=12411&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=12411&amp;d=1&amp;type=norm</blogmap><street>Merituulentie 30</street><city>Espoo</city><state></state><zip>02200</zip><country>Finland</country><phone>+358 9 412 3253</phone><overall>91.66665</overall><imagecount>0</imagecount></location></bmp_locations>
    END_OF_STRING

    stub_request(:get, /.*espoo/).to_return(body: canned_answer, headers: { 'Content-Type' => "text/xml" })

    places = BeermappingApi.places_in("espoo")

    expect(places.size).to eq(1)
    place = places.first
    expect(place.name).to eq("Gallows Bird")
    expect(place.street).to eq("Merituulentie 30")
  end

  it "When HTTP GET returns no entries, an empty array is returned" do

    canned_answer = <<-END_OF_STRING
<?xml version='1.0' encoding='utf-8' ?><bmp_locations><location><id></id><name></name><status></status><reviewlink></reviewlink><proxylink></proxylink><blogmap></blogmap><street></street><city></city><state></state><zip></zip><country></country><phone></phone><overall></overall><imagecount></imagecount></location></bmp_locations>
    END_OF_STRING

    stub_request(:get, /.*orimattila/).to_return(body: canned_answer, headers: { 'Content-Type' => "text/xml" })

    places = BeermappingApi.places_in("orimattila")

    expect(places.size).to eq(0)
  end

  it "When HTTP GET returns many entries, an array is returned" do

    canned_answer = <<-END_OF_STRING
<?xml version='1.0' encoding='utf-8' ?><bmp_locations><location><id>6032</id><name>HopTech Homebrewing Supplies</name><status>Homebrew</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6032</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6032&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6032&amp;d=1&amp;type=norm</blogmap><street>6398 Dougherty Rd no.7</street><city>Dublin</city><state>CA</state><zip>94568</zip><country>United States</country><phone>(925) 875-0246</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>6263</id><name>JW Sweetman</name><status>Brewpub</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6263</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6263&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6263&amp;d=1&amp;type=norm</blogmap><street>1-2 Burgh Quay</street><city>Dublin 2</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+3531 6705777</phone><overall>43.3336</overall><imagecount>4</imagecount></location><location><id>6265</id><name>Bull and Castle, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6265</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6265&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6265&amp;d=1&amp;type=norm</blogmap><street>Christchurch</street><city>Dublin 2</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 4751122</phone><overall>83.3333</overall><imagecount>3</imagecount></location><location><id>6266</id><name>Porterhouse Temple Bar, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6266</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6266&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6266&amp;d=1&amp;type=norm</blogmap><street>16-18 Parliament Street</street><city>Dublin 2</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 679 884</phone><overall>66.666825</overall><imagecount>3</imagecount></location><location><id>6267</id><name>Porterhouse North, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6267</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6267&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6267&amp;d=1&amp;type=norm</blogmap><street>Prospect Road</street><city>Dublin 9</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 830 988</phone><overall>60.00025</overall><imagecount>4</imagecount></location><location><id>6276</id><name>Porterhouse Central, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6276</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6276&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6276&amp;d=1&amp;type=norm</blogmap><street>45-47 Nassau Street</street><city>Dublin</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 6774180</phone><overall>53.33365</overall><imagecount>3</imagecount></location><location><id>6279</id><name>Redmond's</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6279</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6279&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6279&amp;d=1&amp;type=norm</blogmap><street>25 Ranelagh</street><city>Dublin 6</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 4960552</phone><overall>68.33355</overall><imagecount>3</imagecount></location><location><id>6310</id><name>Porterhouse, The</name><status>Brewery</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6310</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6310&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6310&amp;d=1&amp;type=norm</blogmap><street>Unit 6D Rosemount Business Park</street><city>Dublin 15</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>353 1 822 7415</phone><overall>68.3335</overall><imagecount>6</imagecount></location><location><id>6311</id><name>St. James's Gate Brewery (Diageo)</name><status>Brewery</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6311</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6311&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6311&amp;d=1&amp;type=norm</blogmap><street>James's Street</street><city>Dublin 8</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>353 1 4536700</phone><overall>64.99982</overall><imagecount>5</imagecount></location><location><id>6324</id><name>Sweeney's - Prospect Road</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6324</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6324&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6324&amp;d=1&amp;type=norm</blogmap><street>Prospect Road</street><city>Dublin</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>01 874 9808</phone><overall>63.3335</overall><imagecount>1</imagecount></location><location><id>6325</id><name>Lilac Wines</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6325</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6325&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6325&amp;d=1&amp;type=norm</blogmap><street>117 Philipsburgh Avenue</street><city>Dublin 3</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>353 1 8372857</phone><overall>79.99995</overall><imagecount>2</imagecount></location><location><id>6326</id><name>McHugh's - Malahide Road</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6326</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6326&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6326&amp;d=1&amp;type=norm</blogmap><street>25e Malahide Road</street><city>Dublin</city><state></state><zip>5</zip><country>Ireland</country><phone>353 0 18394692</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>6331</id><name>Deveney's - Rathmines</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6331</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6331&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6331&amp;d=1&amp;type=norm</blogmap><street>16 Upper Rathmines Road</street><city>Dublin 6</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 4972392</phone><overall>61.6668</overall><imagecount>2</imagecount></location><location><id>6333</id><name>Drink Store</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6333</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6333&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6333&amp;d=1&amp;type=norm</blogmap><street>87 Manor Street</street><city>Dublin 7</city><state>Co. Dublin</state><zip></zip><country>Ireland</country><phone>+353 1 6719760</phone><overall>83.3333</overall><imagecount>1</imagecount></location><location><id>6970</id><name>Deveney's - Dundrum</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6970</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6970&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6970&amp;d=1&amp;type=norm</blogmap><street>31 Main Street, Dundrum</street><city>Dublin</city><state></state><zip>16</zip><country>Ireland</country><phone>+353 1 298 4288</phone><overall>83.3333</overall><imagecount>1</imagecount></location><location><id>6971</id><name>O'Neill's</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6971</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6971&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6971&amp;d=1&amp;type=norm</blogmap><street>184 South Circular Road</street><city>Dublin</city><state></state><zip>8</zip><country>Ireland</country><phone>+353 1 453 6793</phone><overall>60.0001</overall><imagecount>1</imagecount></location><location><id>6972</id><name>McHugh's - Kilbarrack</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=6972</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=6972&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=6972&amp;d=1&amp;type=norm</blogmap><street>57 Kilbarrack Road</street><city>Dublin</city><state></state><zip>5</zip><country>Ireland</country><phone>+353 1 839 4692</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>7049</id><name>SuperValu - Aston Quay</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=7049</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=7049&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=7049&amp;d=1&amp;type=norm</blogmap><street>Aston Quay</street><city>Dublin</city><state>Ireland</state><zip></zip><country>Ireland</country><phone>+353 1 6795422</phone><overall>40.00015</overall><imagecount>1</imagecount></location><location><id>7275</id><name>D Six</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=7275</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=7275&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=7275&amp;d=1&amp;type=norm</blogmap><street>161 Harold's Cross Road</street><city>Dublin</city><state></state><zip>6W</zip><country>Ireland</country><phone>+353 1 497 2445</phone><overall>66.6666</overall><imagecount>2</imagecount></location><location><id>9627</id><name>Martin's Off Licence and Fine Wines</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=9627</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=9627&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=9627&amp;d=1&amp;type=norm</blogmap><street>11 Marino Mart</street><city>Dublin</city><state></state><zip>Dublin 3</zip><country>Ireland</country><phone>+353 1 8332952</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>10181</id><name>Bin No9</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=10181</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=10181&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=10181&amp;d=1&amp;type=norm</blogmap><street>9 Farmhill Road</street><city>Dublin</city><state></state><zip>Dublin 14</zip><country>Ireland</country><phone></phone><overall>0</overall><imagecount>0</imagecount></location><location><id>10161</id><name>Whelan's</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=10161</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=10161&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=10161&amp;d=1&amp;type=norm</blogmap><street>25 Wexford Street</street><city>Dublin 2</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>68.33325</overall><imagecount>0</imagecount></location><location><id>11414</id><name>Czech Inn, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=11414</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=11414&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=11414&amp;d=1&amp;type=norm</blogmap><street>Essex Gate</street><city>Dublin</city><state></state><zip>8</zip><country>Ireland</country><phone>+353 1 6711535</phone><overall>55.00005</overall><imagecount>1</imagecount></location><location><id>12394</id><name>L. Mulligan. Grocer</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=12394</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=12394&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=12394&amp;d=1&amp;type=norm</blogmap><street>18 Stoneybatter</street><city>Dublin 7</city><state></state><zip>Dublin 7</zip><country>Ireland</country><phone></phone><overall>86.6666</overall><imagecount>0</imagecount></location><location><id>12823</id><name>Against the Grain</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=12823</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=12823&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=12823&amp;d=1&amp;type=norm</blogmap><street>11 Wexford Street</street><city>Dublin</city><state></state><zip>2</zip><country>Ireland</country><phone></phone><overall>90.83335</overall><imagecount>3</imagecount></location><location><id>12827</id><name>O'Neill's</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=12827</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=12827&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=12827&amp;d=1&amp;type=norm</blogmap><street>2 Suffolk Street</street><city>Dublin</city><state></state><zip>2</zip><country>Ireland</country><phone>+353 1 679 3656</phone><overall>60.0001</overall><imagecount>0</imagecount></location><location><id>12852</id><name>Lucan County, The</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=12852</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=12852&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=12852&amp;d=1&amp;type=norm</blogmap><street>N4 Lucan Road</street><city>Dublin</city><state></state><zip></zip><country>Ireland</country><phone>+353 1 6281367</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>13503</id><name>Sweeney's Wine Merchant</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=13503</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=13503&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=13503&amp;d=1&amp;type=norm</blogmap><street>6 Finglas Road, glasnevin</street><city>Dublin</city><state></state><zip>9</zip><country>Ireland</country><phone>+35318309593</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>13710</id><name>Celtic Whiskey Shop</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=13710</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=13710&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=13710&amp;d=1&amp;type=norm</blogmap><street>28 Dawson St</street><city>Dublin</city><state></state><zip>D2</zip><country>Ireland</country><phone>+353 1 6759743</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>14639</id><name>BJ's Brewhouse - Tuttle Crossing</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=14639</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=14639&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=14639&amp;d=1&amp;type=norm</blogmap><street>5141 Tuttle Crossing</street><city>Dublin</city><state>OH</state><zip>43016</zip><country>United States</country><phone>(614) 659-9400</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>15191</id><name>Black Sheep</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=15191</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=15191&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=15191&amp;d=1&amp;type=norm</blogmap><street>61 Capel Street</street><city>Dublin 1</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>86.6667</overall><imagecount>0</imagecount></location><location><id>15597</id><name>Brew Dock</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=15597</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=15597&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=15597&amp;d=1&amp;type=norm</blogmap><street>1 Amiens Street</street><city>Dublin 1</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>80.0001</overall><imagecount>0</imagecount></location><location><id>15894</id><name>Baggot Street Wines</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=15894</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=15894&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=15894&amp;d=1&amp;type=norm</blogmap><street>17 Upper Baggot Street</street><city>Dublin</city><state></state><zip>4</zip><country>Ireland</country><phone>01-667-3033</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>15934</id><name>BJ's Brewhouse - Dublin CA</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=15934</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=15934&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=15934&amp;d=1&amp;type=norm</blogmap><street>3620 Fallon Rd</street><city>Dublin</city><state>CA</state><zip>94538</zip><country>United States</country><phone>925-452-1155</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>17359</id><name>Dark Horse</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=17359</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=17359&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=17359&amp;d=1&amp;type=norm</blogmap><street>31-33 Carysfort Avenue, Blackrock</street><city>Dublin</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>78.33345</overall><imagecount>2</imagecount></location><location><id>17360</id><name>Magpie Inn</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=17360</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=17360&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=17360&amp;d=1&amp;type=norm</blogmap><street>115 Coliemore Road, Dalkey</street><city>Dublin</city><state></state><zip></zip><country>Ireland</country><phone>+353 1 202 3909</phone><overall>88.33325</overall><imagecount>0</imagecount></location><location><id>17537</id><name>Caps and Taps</name><status>Beer Store</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=17537</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=17537&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=17537&amp;d=1&amp;type=norm</blogmap><street>6601 Dublin Blvd, Suite M</street><city>Dublin</city><state>CA</state><zip>94568</zip><country>United States</country><phone>925-248-2139</phone><overall>0</overall><imagecount>0</imagecount></location><location><id>18611</id><name>Five Lamps Brewery</name><status>Brewery</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=18611</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=18611&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=18611&amp;d=1&amp;type=norm</blogmap><street>Whiteswan Business Centre</street><city>Dublin 8</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>0</overall><imagecount>0</imagecount></location><location><id>18612</id><name>57 The Headline</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=18612</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=18612&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=18612&amp;d=1&amp;type=norm</blogmap><street>57 Clanbrassil Street Lower</street><city>Dublin 8</city><state></state><zip></zip><country>Ireland</country><phone></phone><overall>0</overall><imagecount>0</imagecount></location><location><id>19118</id><name>Brazenhead</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=19118</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=19118&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=19118&amp;d=1&amp;type=norm</blogmap><street>56 N. High St</street><city>Dublin</city><state>OH</state><zip>43017</zip><country>United States</country><phone>614-792-3738</phone><overall>0</overall><imagecount>0</imagecount></location></bmp_locations>
    END_OF_STRING

    stub_request(:get, /.*dublin/).to_return(body: canned_answer, headers: { 'Content-Type' => "text/xml" })

    places = BeermappingApi.places_in("dublin")

    expect(places.size).to eq(40)
    place = places.first
    expect(place.name).to eq("HopTech Homebrewing Supplies")
    expect(place.street).to eq("6398 Dougherty Rd no.7")
  end

  describe "in case of cache miss" do

    before :each do
      Rails.cache.clear
    end

    it "When HTTP GET returns one entry, it is parsed and returned" do
      canned_answer = <<-END_OF_STRING
<?xml version='1.0' encoding='utf-8' ?><bmp_locations><location><id>13307</id><name>O'Connell's Irish Bar</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=13307</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=13307&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=13307&amp;d=1&amp;type=norm</blogmap><street>Rautatienkatu 24</street><city>Tampere</city><state></state><zip>33100</zip><country>Finland</country><phone>35832227032</phone><overall>0</overall><imagecount>0</imagecount></location></bmp_locations>
      END_OF_STRING

      stub_request(:get, /.*tampere/).to_return(body: canned_answer, headers: {'Content-Type' => "text/xml"})

      places = BeermappingApi.places_in("tampere")

      expect(places.size).to eq(1)
      place = places.first
      expect(place.name).to eq("O'Connell's Irish Bar")
      expect(place.street).to eq("Rautatienkatu 24")
    end
  end

  describe "in case of cache hit" do

    it "When one entry in cache, it is returned" do
      canned_answer = <<-END_OF_STRING
<?xml version='1.0' encoding='utf-8' ?><bmp_locations><location><id>13307</id><name>O'Connell's Irish Bar</name><status>Beer Bar</status><reviewlink>http://beermapping.com/maps/reviews/reviews.php?locid=13307</reviewlink><proxylink>http://beermapping.com/maps/proxymaps.php?locid=13307&amp;d=5</proxylink><blogmap>http://beermapping.com/maps/blogproxy.php?locid=13307&amp;d=1&amp;type=norm</blogmap><street>Rautatienkatu 24</street><city>Tampere</city><state></state><zip>33100</zip><country>Finland</country><phone>35832227032</phone><overall>0</overall><imagecount>0</imagecount></location></bmp_locations>
      END_OF_STRING

      stub_request(:get, /.*tampere/).to_return(body: canned_answer, headers: {'Content-Type' => "text/xml"})

      # ensure that data found in cache
      BeermappingApi.places_in("tampere")

      places = BeermappingApi.places_in("tampere")

      expect(places.size).to eq(1)
      place = places.first
      expect(place.name).to eq("O'Connell's Irish Bar")
      expect(place.street).to eq("Rautatienkatu 24")
    end
  end
end